---
title: "Išgyvenimumo analizė"
author: "Vainius Gataveckas, Matas Gaulia, Dovydas Martinkus"
output:
   word_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(modeldata)

data("wa_churn")

x <- wa_churn


set.seed(123)
x <- x[sample(nrow(x), nrow(x)*0.05), ]
x <- x %>% filter(tenure > 0)
```


```{r}
library(survival)
library(survminer)


x <- x %>%
  select(churn,tenure,female,monthly_charges,phone_service,internet_service,senior_citizen,
         dependents,partner) %>%
  mutate(internet_service = factor(if_else(internet_service=="No",0,1))) %>%
  mutate(across(-c(monthly_charges,tenure),~as.factor(.)),
         churn = if_else(churn=="No",1,0))
        
```



```{r}
table(x$churn)
prop.table(table(x$churn))


# median time until default (taking into account just no cendored data)
median(x$tenure[x$churn==0])  # I'm underestimating


# median time until default (with all data)
median(x$tenure)  # I'm underestimating the median survival too 
# (in censored times, the real time is bigger)
```

```{r}
plot <- function(column) {
  ggplot(x,aes({{column}},tenure,color=factor(churn))) + 
    geom_point(aes(size=factor(churn)), position=position_jitter(width=0.01,height=0.1)) +
    scale_x_discrete()  + 
    coord_flip() +
    theme_minimal() + 
    scale_size_manual(values=c("1"=2,"0"=4))
}


plot(female)
plot(senior_citizen)
plot(partner)
plot(dependents)
```



```{r}
km <- survfit(Surv(tenure, churn) ~ 1, data = x)

print(km, print.rmean = TRUE)

ggsurvplot(km)
```


```{r}
individual <- function(variable,title) {
  model <- 
    eval(substitute(survfit(Surv(tenure, churn) ~ variable , data = x)))
  
  print(model,print.rmean=TRUE)
  
  print(eval(substitute(survdiff(Surv(tenure, churn) ~ variable, data = x, rho = 0))))
  
  ggsurvplot(model,
             conf.int = TRUE,
             pval = TRUE,
             fun = "pct",
             risk.table = TRUE,
             size = 1,
             linetype = "strata",
             palette = c("#E7B800",
             "#2E9FDF"),
             legend = "bottom",
             legend.title = title,)
}


individual(female,"Is Female")
individual(senior_citizen,"Is Senior")
individual(partner,"Has a partner")
individual(dependents,"Has dependents")
```




```{r}
cox <- coxph(Surv(tenure,churn) ~ phone_service + dependents + internet_service + 
               senior_citizen + monthly_charges + female + partner, data = x)

summary(cox)
```


```{r}
cox.zph(cox)

ggcoxdiagnostics(cox, type = "schoenfeld")
```



```{r}
# Kadangi kovariantes, kurios pagal modelio diagnostikas pazeidžia proporcingų
  # rizikos funkcijų prielaidą pagal tyrimo tikslus yra nepagrindinės (nuisance)
  # naudojamas sluoksniavimas
x$monthly_charges_binned = cut_number(x$monthly_charges,3)

cox2 <- coxph(Surv(tenure,churn) ~ phone_service + dependents + female + partner + strata(internet_service) + 
               senior_citizen + strata(monthly_charges_binned), data = x)
```




```{r}
exp(confint(cox2)) %>% cbind(exp(coef(cox2))) %>% as.data.frame() %>% tibble::rownames_to_column() %>% as_tibble() %>% set_names(c("variable","low","high","coef")) %>% 
  ggplot(aes(variable,coef)) + 
  geom_pointrange(aes(ymin=low,ymax=high),color="blue") + 
  coord_flip() + theme_minimal() + geom_hline(yintercept = 1, color = "black",linetype="dashed")
```


```{r}
cox3 <- coxph(Surv(tenure,churn) ~ phone_service  + partner + strata(internet_service)  + strata(monthly_charges_binned), data = x)


summary(cox2)
```














```{r}

library(eha)

aft <- aftreg(Surv(tenure,churn) ~ phone_service + dependents + internet_service + female + 
               senior_citizen + monthly_charges,
              data = x)
```





```{r}
plot(aft)
```




```{r}
```

