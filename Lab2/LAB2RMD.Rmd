---
title: "LAB2RMD"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r }
# Duomenys 
# https://www.kaggle.com/datasets/brajeshmohapatra/bike-count-prediction-data-set?select=train.csv

library(tidyverse)
library(ggplot2)
library(reshape2)
library(AER)
library(MASS)

d <- read.csv("train.csv")
d <- dplyr::select(d, -c(datetime, casual, registered))

head(d)
summary(d)
```

```{r}
ggplot(melt(d, "count"), aes(x = value, y = count, colour = variable)) + 
  geom_point() + 
  facet_wrap(~variable, scales = "free", nrow = 4)
```


```{r}
### Poisson
m1 <- glm(count ~ ., family="poisson", data=d)
summary(m1)

cat("Deviacija padalinta is laisves laipsniu: ",m1$deviance / m1$df.residual)
cat("Turi buti tarp 0.7 ir 1.3, tad nebegalime naudoti puasono modelio")

dispersiontest(m1)
```

```{r }
### Negative Binomial
m2 <- glm.nb(count ~ ., data = d)
summary(m2)

cat("Deviacija padalinta is laisves laipsniu: ",m2$deviance / m2$df.residual)
```

```{r }
### Stepwise
m2step <- stepAIC(m2, direction = "both")
summary(m2step)
cat("Deviacija padalinta is laisves laipsniu: ",m2step$deviance / m2step$df.residual)
```

```{r }
# Anova between models 
anova(m2, m2step)
```

```{r }
# Koeficientai
est <- cbind(Estimate = coef(m2step), confint(m2step))
exp(est)

```

```{r }
library(ggplot2)
theme_set(theme_minimal())
### Prediction

dopred <- function(tt, model) { 
  tt$count <- tt$casual + tt$registered
  index <- tt$index
  real <- tt$count
  tt <- dplyr::select(tt, -c(datetime, casual, registered, count))
  predicted <- predict(m2step, newdata = tt, type = "response")
  tempdf <- data.frame(index, real, predicted)
  
  p<- ggplot(tempdf, aes(x=index)) + 
    geom_line(aes(y = real), color = "#0F9D58") + 
    geom_line(aes(y = predicted), color="#4285F4", linetype="twodash") 
  return(p)
}


test <- read.csv("test.csv")
test$index <- 1:nrow(test)

num_groups = 8

totest <- test %>% 
  group_by((row_number()-1) %/% (n()/num_groups)) %>%
  nest %>% pull(data)

head(test)

```

```{r }
plots <- list()  # new empty list
for (i in 1:8) {
  p1 = dopred(data.frame(totest[i]))
  plots[[i]] <- p1  # add each plot into plot list
}
plots
```











